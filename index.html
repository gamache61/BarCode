<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BAR</title>
    
    <link rel="manifest" href="manifest.json">
    
    <link rel="apple-touch-icon" href="icon.svg">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin: 20px; }
        /* Make sure the camera container is visible */
        #scanner-container { 
            width: 100%; 
            max-width: 600px; 
            height: 300px; 
            margin: 0 auto; 
            background: #eee; 
            border: 2px dashed #ccc;
            position: relative;
            overflow: hidden;
        }
        /* This targets the video element Quagga creates automatically */
        #scanner-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        /* Drawing box for barcode detection */
        .drawingBuffer {
            position: absolute;
            top: 0;
            left: 0;
        }
        #result, #total { font-size: 1.2em; margin: 10px; }
        #cart { list-style: none; padding: 0; }
        #cart li { margin: 5px 0; }
        .error-msg { color: red; font-weight: bold; }
    </style>
</head>
<body>
    <h1>BAR</h1>
    
    <div id="scanner-container"></div>

    <br>
    <input type="number" id="tax-rate" placeholder="Enter tax rate (%)" step="0.01" min="0">
    <button onclick="startScanner()">Start Scanner</button>
    <div id="result">Scan a barcode...</div>
    <ul id="cart"></ul>
    <div id="total">Total: $0.00</div>

    <script>
        const items = {
            '123456789012': { name: 'Item 1', price: 10.00 },
            '987654321098': { name: 'Item 2', price: 15.50 },
            // Add more items here
        };
        let cart = [];
        let taxRate = 0;

        document.getElementById('tax-rate').addEventListener('input', (e) => {
            taxRate = parseFloat(e.target.value) / 100 || 0;
            updateTotal();
        });

        function startScanner() {
            // --- SAFETY CHECK 1: PROTOCOL ---
            if (location.protocol === 'file:') {
                alert("ERROR: Camera Blocked!\n\nYou must host this on a server (like Netlify) or use 'Live Server' in VS Code.");
                document.getElementById('result').innerHTML = "<span class='error-msg'>Camera blocked. You must use a Server (HTTPS).</span>";
                return;
            }

            // --- SAFETY CHECK 2: BROWSER SUPPORT ---
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert("Your browser does not support camera access in this context.");
                return;
            }

            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#scanner-container'),
                    constraints: {
                        facingMode: "environment" 
                    }
                },
                decoder: { readers: ["upc_reader", "ean_reader"] }
            }, (err) => {
                if (err) {
                    console.error(err);
                    document.getElementById('result').innerHTML = `<span class='error-msg'>Camera Error: ${err.name}</span>`;
                    alert(`Camera Error: ${err.name}\nCheck permissions.`);
                    return;
                }
                console.log("Initialization finished. Ready to start");
                Quagga.start();
            });

            Quagga.onDetected((data) => {
                const code = data.codeResult.code;
                document.getElementById('result').textContent = `Scanned: ${code}`;
                addToCart(code);
                Quagga.stop();
                setTimeout(startScanner, 1000); 
            });
        }

        function addToCart(code) {
            const item = items[code];
            if (item) {
                cart.push(item);
                const li = document.createElement('li');
                li.textContent = `${item.name} - $${item.price.toFixed(2)}`;
                document.getElementById('cart').appendChild(li);
                updateTotal();
            } else {
                alert('Item not found: ' + code);
            }
        }

        function updateTotal() {
            const subtotal = cart.reduce((sum, item) => sum + item.price, 0);
            const tax = subtotal * taxRate;
            const total = subtotal + tax;
            document.getElementById('total').textContent = `Total: $${total.toFixed(2)} (Subtotal: $${subtotal.toFixed(2)}, Tax: $${tax.toFixed(2)})`;
        }

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then((reg) => console.log('BAR Brain loaded!', reg))
                    .catch((err) => console.log('BAR Brain failed:', err));
            });
        }
    </script>
</body>
</html>
